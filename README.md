# ИДЗ 2
Кадыкова Татьяна Алексеевна, БПИ213

Вариант 34

Тесты, на которых проверялась работа программ, находятся в папке `test`.
Файлы с названиями `input*.txt` являются входными файлами.
Выходные файлы с названиями `output*.txt` находятся в папках соответствующих программ.
Обязательным для запуска является указание файла `decoder.txt`, в данном проекте он находится
в корне, он использовался для всех входных файлов.

## Задание
И снова пляшущие человечки. Узнав о планах преступников по
шифрованию текстов, Шерлок Холмс предложил лондонской полиции специальную машину для дешифровки сообщений злоумышленников. Реализовать приложение, дешифрующее кодированный текст. В качестве ключа используется известная кодовая таблица, устанавливающая однозначное соответствие между каждой буквой и каким-нибудь числом. Процессом узнавания кода в решении задачи пренебречь. Каждый процесс–дешифровщик декодирует свои кусочки текста, многократно получаемые от менеджера. Распределение фрагментов
текста между процессами–дешифровщиками осуществляется процессом–
менеджером, который передает каждому процессу фрагмент зашифрованного текста, 
получает от него результат, передает следующий зашифрованный фрагмент. 
Он же собирает из отдельных
фрагментов зашифрованный текст. Количество процессов задается опционально. 
Каждый процесс может выполнять свою работу за случайное время.

## Компиляция и запуск на оценки 4-6
Компиляция через: `gcc main.c -o r1 -lpthread -lrt`

Запуск программы происходит через `./r1 <decoder file> <input file> <output file> <number of processes>`.

Многие общие глобальные переменные были вынесены в файл `info.h`, для более удобного пользования,
такие как переменные shmid, mem_name и тд., а также некоторые функции.

## На 4
Код находится в `for4/main.c`.
Использовалась разделяемая память по названию "shared-memory", 
именованные семафоры, имена которых генерируются. Размер разделяемой памяти - массив типа message_h размера pros_num 
(количество процессов-дешифровальщиков). Каждый процесс дешифровки обращается к одной ячейке
разделяемой памяти (функция процесса принимает его номер (`id` в параметрах)) по своему номеру.
В этой ячейке - сообщение - происходит общение менеджера и конкретного дешифровальщика.
Тип message_h хранит в себе: тип сообщение (передаются INT, STRING или FINISH - показатель 
требования завершить процесс, когда закончилась дешифровка), размер текущего сообщения (не больше MAX_INTS),
место для семафоров (на 5 и 6 оценки) - 2 штуки для каждого процесса, и union, куда записывается строка (uncoded) 
и массив интов (кодированное сообщение в coded).
Родительский процесс создает требуемое число дочерних процессов для дешифровки, создает именованные семафоры
по 2 на каждый процесс. Один семафор (хранится в массиве `parent_semaphores`) используется для
сигнала родителю-менеджеру о завершении дешифровки кусочка, второй семафор (хранится в массиве
`child_semaphores`) используется для сигнала дешифровщику о старте работы над новым кусочком.
После завершения декодирования всего сообщения родитель закрывает все семафоры и разделяемую память.
В случае завершения работы по сигналу Ctrl+C также происходит принудительное закрытие всего и завершение программы.

## На 5
Код находится в `for5/main.c`.
Отличие работы от `на 4` заключается в том, что используются неименованные семафоры, хранящиеся в разделяемой памяти.
Они хранятся в ячейке сообщения типа message_t в полях child_sem и parent_sem, и используются 
аналогично семафорам предыдущей программы. 

## На 6
Код находится в `for6/main.c`.
Отличие работы программы от `на 5` заключается в том, что разделяемая память теперь создается
в стандарте UNIX SYSTEM V, как и семафоры. Создается массив семафоров 2 * количество дешифровщиков.
Первая половина (номера 0 - N-1) работают как child semaphores, а вторая (номера N - 2N-1)
работают как parent semaphores из предыдущих программ.

## На 7
Код находится в `for7/parent.c` и `for7/child.c`.
Общая программа с дочерними процессами и процессом-менеджером (все зависимые процессы)
была разделена на 2 программы (независимые процессы).
Первая программа (parent.c) контролирует работу дешифровщиков, то есть процесс-менеджер.
Вторая программа (child.c) создает требуемое количество дочерних процессов. 
Синхронизация ведется через именованные семафоры в стандарте POSIX, аналогично оценке на 4.
Данные передаются через разделяемую память, программы имеют общие "ключи", хранящиеся в `info.h`.

Запуск приложения происходит с двух терминалов. 
Сначала компилируем программы по примеру:

`gcc parent.c -o r1 -lpthread -lrt`
`gcc child.c -o r2 -lpthread -lrt`

Запуск соответствующих процессов происходит так:
`./r1 <input file> <output file> <number of processes>` - первой программе
требуются в данном порядке: входной файл, выходной файл и количество процессов.

`./r2 <decoder file> <number of processes>` - второй программе
требуются в данном порядке: файл-ключ для декодирования и количество процессов.

Количества процессов, указанные в параметрах, должны быть одинаковыми, иначе процессам не
удастся подключиться к разделяемой памяти и семафорам.

Реакция на сигнал Ctrl+C была обновлена в связи с наличием теперь двух независимых процессов,
и требованием о корректном закрытии всех семафоров и разделяемой памяти, в случае сигнала на любой процесс.

Был также добавлен семафор, который используется родительским процессом второй программы, для
завершения процесса только тогда, когда первая программа отработала (дешифровка завершилась).

## На 8
Отличия от приложения на 7 заключаются в том, что используются семафоры и разделяемая память
в стандарте UNIX SYSTEM V.
